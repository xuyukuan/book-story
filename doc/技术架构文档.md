# Book's Story 技术架构文档

## 📋 目录
1. [项目概述](#项目概述)
2. [项目整体架构图和技术栈说明](#项目整体架构图和技术栈说明)
3. [核心模块功能解析和代码结构说明](#核心模块功能解析和代码结构说明)
4. [关键技术实现原理和关键代码片段分析](#关键技术实现原理和关键代码片段分析)
5. [数据流向和接口设计说明](#数据流向和接口设计说明)
6. [部署架构和依赖关系说明](#部署架构和依赖关系说明)
7. [性能优化和安全考虑要点](#性能优化和安全考虑要点)

---

## 📖 项目概述

**Book's Story** 是一款基于 Material You 设计的开源电子书阅读器，专为 Android 平台开发。该应用采用现代化的 Android 开发技术栈，支持多种文件格式，提供高度可定制的阅读体验。

### 核心特性
- 支持 7 种文件格式：`.pdf`、`.txt`、`.epub`、`.fb2`、`.html`、`.htm`、`.md`
- Material You 设计语言，支持动态主题和颜色预设
- 基于 Storage Access Framework 的文件管理
- 高度可定制的阅读界面
- 完全开源、无广告

---

## 🏗️ 项目整体架构图和技术栈说明

### 架构模式
```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   UI Components │  │   ViewModels    │  │  Navigation  │ │
│  │  (Jetpack       │  │   (Hilt)        │  │   System     │ │
│  │   Compose)      │  │                 │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     Domain Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Use Cases     │  │   Repositories  │  │   Entities   │ │
│  │                 │  │   (Interfaces)  │  │              │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      Data Layer                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Repository    │  │   Local Data    │  │  File        │ │
│  │ Implementations │  │   (Room DB)     │  │  Parsers     │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈

#### 核心框架
- **Kotlin**: 主要开发语言
- **Jetpack Compose**: 现代化 UI 框架
- **Android Gradle Plugin**: 构建系统
- **Material 3**: UI 设计系统

#### 架构组件
- **Hilt**: 依赖注入框架
- **Room**: 本地数据库 ORM
- **DataStore**: 轻量级数据存储
- **Navigation Compose**: 导航管理
- **Lifecycle**: 生命周期管理

#### 文件解析
- **PDFBox**: PDF 文件解析
- **JSoup**: HTML/XML 解析
- **CommonMark**: Markdown 解析

#### 其他核心库
- **Coil**: 图片加载
- **Gson**: JSON 序列化
- **AboutLibraries**: 开源许可证管理

---

## 🔧 核心模块功能解析和代码结构说明

### 项目结构
```
app/src/main/java/ua/acclorite/book_story/
├── Application.kt                    # 应用入口点
├── core/                            # 核心工具类
├── data/                            # 数据层
│   ├── di/                          # 依赖注入配置
│   ├── local/                       # 本地数据存储
│   │   ├── dto/                     # 数据传输对象
│   │   └── room/                    # Room 数据库
│   ├── mapper/                      # 数据映射器
│   ├── parser/                      # 文件解析器
│   └── repository/                  # Repository 实现
├── domain/                          # 领域层
│   ├── repository/                  # Repository 接口
│   ├── use_case/                    # 用例
│   └── util/                        # 工具类
├── presentation/                    # 表现层
│   ├── about/                       # 关于页面
│   ├── book_info/                   # 书籍信息页面
│   ├── browse/                      # 浏览页面
│   ├── core/                        # 核心 UI 组件
│   ├── help/                        # 帮助页面
│   ├── history/                     # 历史记录页面
│   ├── library/                     # 图书馆页面
│   ├── navigator/                   # 导航组件
│   ├── reader/                      # 阅读器页面
│   └── settings/                    # 设置页面
└── ui/                              # UI 主题和样式
```

### 核心模块详解

#### 1. 数据层 (Data Layer)
负责数据的获取、存储和管理，包括：

**Room 数据库配置**
```kotlin
@Database(
    entities = [
        BookEntity::class,
        HistoryEntity::class,
        ColorPresetEntity::class,
    ],
    version = 9,
    autoMigrations = [
        AutoMigration(1, 2),
        AutoMigration(2, 3),
        // ... 更多迁移配置
    ],
    exportSchema = true
)
abstract class BookDatabase : RoomDatabase() {
    abstract val dao: BookDao
}
```

**Repository 模式实现**
```kotlin
@Singleton
class BookRepositoryImpl @Inject constructor(
    private val application: Application,
    private val database: BookDao,
    private val bookMapper: BookMapper,
    private val fileParser: FileParser,
    private val textParser: TextParser
) : BookRepository {
    // 具体实现...
}
```

#### 2. 领域层 (Domain Layer)
包含业务逻辑和用例：

**用例示例**
```kotlin
class InsertBook @Inject constructor(
    private val repository: BookRepository
) {
    suspend operator fun invoke(book: Book): Boolean {
        return repository.insertBook(book)
    }
}
```

#### 3. 表现层 (Presentation Layer)
基于 Jetpack Compose 的 UI 层：

**ViewModel 示例**
```kotlin
@HiltViewModel
class MainModel @Inject constructor(
    private val dataStoreRepository: DataStoreRepository,
    // ... 其他依赖
) : ViewModel() {
    // UI 状态管理
}
```

---

## ⚙️ 关键技术实现原理和关键代码片段分析

### 1. 依赖注入架构 (Hilt)

**应用入口配置**
```kotlin
@HiltAndroidApp
class Application : Application() {
    // Hilt 自动生成依赖注入代码
}
```

**模块配置**
```kotlin
@Module
@InstallIn(SingletonComponent::class)
abstract class RepositoryModule {
    
    @Binds
    @Singleton
    abstract fun bindBookRepository(
        bookRepositoryImpl: BookRepositoryImpl
    ): BookRepository
    
    // ... 其他绑定
}
```

### 2. 文件解析系统

**多格式文件解析器**
```kotlin
class FileParserImpl @Inject constructor(
    private val txtFileParser: TxtFileParser,
    private val pdfFileParser: PdfFileParser,
    private val epubFileParser: EpubFileParser,
    private val fb2FileParser: Fb2FileParser,
    private val htmlFileParser: HtmlFileParser,
) : FileParser {

    override suspend fun parse(cachedFile: CachedFile): BookWithCover? {
        val fileFormat = ".${cachedFile.name.substringAfterLast(".")}".lowercase().trim()
        return when (fileFormat) {
            ".pdf" -> pdfFileParser.parse(cachedFile)
            ".epub" -> epubFileParser.parse(cachedFile)
            ".txt" -> txtFileParser.parse(cachedFile)
            ".fb2" -> fb2FileParser.parse(cachedFile)
            ".html", ".htm" -> htmlFileParser.parse(cachedFile)
            ".md" -> txtFileParser.parse(cachedFile)
            else -> null
        }
    }
}
```

**PDF 解析实现**
```kotlin
class PdfTextParser @Inject constructor(
    private val markdownParser: MarkdownParser,
    private val application: Application
) : TextParser {

    override suspend fun parse(cachedFile: CachedFile): List<ReaderText> {
        PDFBoxResourceLoader.init(application)
        
        val pdfStripper = PDFTextStripper()
        pdfStripper.paragraphStart = "</br>"

        PDDocument.load(cachedFile.openInputStream()).use {
            val oldText = pdfStripper.getText(it).replace("\r", "")
            // 文本处理和格式化...
        }
    }
}
```

### 3. Jetpack Compose 导航系统

**自定义导航器**
```kotlin
@Composable
fun Navigator(
    modifier: Modifier = Modifier,
    initialScreen: Screen,
    transitionSpec: AnimatedContentTransitionScope<Screen>.(lastEvent: StackEvent) -> ContentTransform,
    content: @Composable (currentScreen: Screen) -> Unit
) {
    val navigator = rememberNavigator(initialScreen = initialScreen)
    
    CompositionLocalProvider(LocalNavigator provides navigator) {
        AnimatedContent(
            modifier = modifier.fillMaxSize().background(MaterialTheme.colorScheme.surface),
            targetState = currentScreen.value,
            transitionSpec = { transitionSpec(this, lastEvent.value) },
            content = { content(it) }
        )
    }
}
```

### 4. Material You 主题系统

**动态主题配置**
```kotlin
@Composable
fun BookStoryTheme(
    theme: Theme,
    isDark: Boolean,
    isPureDark: Boolean,
    themeContrast: ThemeContrast,
    content: @Composable () -> Unit
) {
    val colorScheme = colorScheme(
        theme = theme,
        darkTheme = isDark,
        isPureDark = isPureDark,
        themeContrast = themeContrast
    )
    val animatedColorScheme = animateColorScheme(targetColorScheme = colorScheme)

    MaterialTheme(
        colorScheme = animatedColorScheme,
        shapes = Shapes(),
        typography = Typography(),
        content = content
    )
}
```

---

## 🔄 数据流向和接口设计说明

### 数据流向图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    UI       │───▶│  ViewModel  │───▶│  Use Case   │
│ (Compose)   │◀───│   (Hilt)    │◀───│             │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Local     │◀───│ Repository  │◀───│   Domain    │
│ Database    │───▶│    Impl     │───▶│ Repository  │
│  (Room)     │    │             │    │ Interface   │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │ File Parser │
                   │   System    │
                   └─────────────┘
```

### 核心接口设计

#### 1. Repository 接口
```kotlin
interface BookRepository {
    suspend fun insertBook(book: Book): Boolean
    suspend fun updateBooks(books: List<Book>): Boolean
    suspend fun deleteBooks(books: List<Book>): Boolean
    suspend fun searchBooks(query: String): List<Book>
    suspend fun findBookById(id: Int): Book?
}
```

#### 2. 文件解析接口
```kotlin
interface FileParser {
    suspend fun parse(cachedFile: CachedFile): BookWithCover?
}

interface TextParser {
    suspend fun parse(cachedFile: CachedFile): List<ReaderText>
}
```

#### 3. 数据访问接口 (DAO)
```kotlin
@Dao
interface BookDao {
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertBook(book: BookEntity)
    
    @Query("SELECT * FROM bookentity WHERE LOWER(title) LIKE '%' || LOWER(:query) || '%'")
    suspend fun searchBooks(query: String): List<BookEntity>
    
    @Query("SELECT * FROM bookentity WHERE id=:id")
    suspend fun findBookById(id: Int): BookEntity
    
    @Delete
    suspend fun deleteBooks(books: List<BookEntity>)
    
    @Update
    suspend fun updateBooks(books: List<BookEntity>)
}
```

### 数据模型

#### 1. 核心实体
```kotlin
@Entity(tableName = "bookentity")
data class BookEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0,
    val title: String,
    val author: String,
    val description: String?,
    val scrollIndex: Int,
    val scrollOffset: Int,
    val progress: Float,
    val filePath: String,
    val lastOpened: Long?,
    val category: Category,
    val coverImage: ByteArray?
)
```

#### 2. 历史记录实体
```kotlin
@Entity(tableName = "historyentity")
data class HistoryEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0,
    val bookId: Int,
    val time: Long
)
```

---

## 🚀 部署架构和依赖关系说明

### 构建配置

#### 1. 项目级 build.gradle.kts
```kotlin
plugins {
    alias(libs.plugins.android.application) apply false
    alias(libs.plugins.kotlin.android) apply false
    alias(libs.plugins.kotlin.compose) apply false
    alias(libs.plugins.hilt) apply false
    alias(libs.plugins.ksp) apply false
    alias(libs.plugins.room) apply false
    alias(libs.plugins.aboutlibraries) apply false
}
```

#### 2. 应用级 build.gradle.kts
```kotlin
plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.compose)
    alias(libs.plugins.hilt)
    alias(libs.plugins.ksp)
    alias(libs.plugins.room)
    alias(libs.plugins.aboutlibraries)
}

android {
    namespace = "ua.acclorite.book_story"
    compileSdk = 35

    defaultConfig {
        applicationId = "ua.acclorite.book_story"
        minSdk = 26
        targetSdk = 35
        versionCode = 10
        versionName = "1.5.0"
    }
}
```

### 核心依赖关系

#### 1. UI 框架依赖
```kotlin
dependencies {
    // Compose BOM
    implementation(platform(libs.compose.bom))
    implementation(libs.compose.ui)
    implementation(libs.compose.ui.tooling.preview)
    implementation(libs.compose.material3)
    implementation(libs.compose.material.icons.extended)
    
    // Activity Compose
    implementation(libs.activity.compose)
}
```

#### 2. 架构组件依赖
```kotlin
dependencies {
    // Hilt
    implementation(libs.hilt.android)
    implementation(libs.hilt.navigation.compose)
    ksp(libs.hilt.compiler)
    
    // Room
    implementation(libs.room.runtime)
    implementation(libs.room.ktx)
    ksp(libs.room.compiler)
    
    // Lifecycle
    implementation(libs.lifecycle.viewmodel.compose)
    implementation(libs.lifecycle.runtime.compose)
}
```

#### 3. 文件解析依赖
```kotlin
dependencies {
    // PDF 解析
    implementation(libs.pdfbox.android)
    
    // HTML/XML 解析
    implementation(libs.jsoup)
    
    // Markdown 解析
    implementation(libs.commonmark)
}
```

### 发布渠道
- **GitHub Releases**: 主要发布渠道
- **F-Droid**: 开源应用商店
- **IzzyOnDroid**: F-Droid 第三方仓库
- **GitLab**: 镜像发布
- **Codeberg**: 镜像发布

---

## ⚡ 性能优化和安全考虑要点

### 性能优化策略

#### 1. 内存管理
- **文件流管理**: 使用 `use` 扩展函数确保资源正确释放
```kotlin
PDDocument.load(cachedFile.openInputStream()).use { document ->
    // 处理文档
} // 自动关闭资源
```

- **大文件处理**: 异步解析和分块处理
```kotlin
suspend fun parseEpub(): List<ReaderText> = withContext(Dispatchers.IO) {
    val jobs = chapterEntries.mapIndexed { index, entry ->
        async(dispatcher) {
            yield() // 协程让步
            parseChapter(entry)
        }
    }
    jobs.awaitAll()
}
```

#### 2. UI 性能优化
- **Compose 重组优化**: 使用 `remember` 和 `LaunchedEffect`
```kotlin
@Composable
fun BookItem(book: Book) {
    val animatedProgress = animateFloatAsState(
        targetValue = book.progress
    )
    // UI 实现...
}
```

- **懒加载列表**: 使用 `LazyColumn` 和 `LazyListState`
```kotlin
LazyColumn(
    state = listState,
    contentPadding = contentPadding
) {
    items(books) { book ->
        BookItem(book = book)
    }
}
```

#### 3. 数据库优化
- **索引优化**: 为常用查询字段添加索引
- **批量操作**: 使用事务处理批量数据操作
- **自动迁移**: 使用 Room 的 AutoMigration 功能

### 安全考虑

#### 1. 文件访问安全
- **Storage Access Framework**: 使用 SAF 确保文件访问权限
- **路径验证**: 验证文件路径的合法性
```kotlin
private fun CachedFile.canAccess(): Boolean {
    return try {
        openInputStream()?.use { true } ?: false
    } catch (e: Exception) {
        false
    }
}
```

#### 2. 数据保护
- **本地数据加密**: Room 数据库可配置加密
- **敏感信息处理**: 避免在日志中输出敏感信息
```kotlin
Log.i(TAG, "Processing file: ${file.name}") // 只记录文件名
```

#### 3. 权限管理
- **最小权限原则**: 只请求必要的权限
- **运行时权限**: 动态请求存储权限
```xml
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
```

#### 4. 代码安全
- **混淆配置**: 使用 ProGuard/R8 进行代码混淆
- **依赖安全**: 定期更新依赖库版本
- **输入验证**: 对用户输入进行验证和清理

### 监控和调试

#### 1. 日志系统
```kotlin
private const val TAG = "BookParser"

Log.i(TAG, "Started parsing: ${file.name}")
Log.w(TAG, "Could not parse file format")
Log.e(TAG, "Parsing failed", exception)
```

#### 2. 错误处理
```kotlin
try {
    parseFile(file)
} catch (e: Exception) {
    Log.e(TAG, "Parse error", e)
    return null
}
```

#### 3. 性能监控
- 使用 Android Studio Profiler 监控内存和 CPU 使用
- 实现自定义性能指标收集
- 监控应用启动时间和响应时间

---

## 📝 总结

Book's Story 采用了现代化的 Android 开发架构，遵循 Clean Architecture 原则，具有以下特点：

1. **模块化设计**: 清晰的分层架构，便于维护和扩展
2. **现代技术栈**: 使用最新的 Android 开发技术和最佳实践
3. **高性能**: 优化的文件解析和 UI 渲染性能
4. **安全可靠**: 完善的权限管理和错误处理机制
5. **用户体验**: Material You 设计，高度可定制

该架构设计确保了应用的可扩展性、可维护性和性能表现，为用户提供了优秀的电子书阅读体验。

---

*文档生成时间: 2025年1月*
*项目版本: v1.5.0*